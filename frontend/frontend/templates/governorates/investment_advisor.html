{% extends 'base.html' %}

{% block title %}Investment Advisor - Economic Intelligence Platform{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4 text-center">Investment Advisor</h1>
    <p class="lead text-center">Get data-driven recommendations for the best locations in Tunisia for your business sector.</p>

    <div class="card card-custom shadow-sm mb-5">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-8 offset-md-2">
                    <label for="sectorSelect" class="form-label fw-bold"><i class="fas fa-industry me-2"></i>Select Business Sector:</label>
                    <select class="form-select" id="sectorSelect">
                        <option value="">-- Choose a Sector --</option>
                        <!-- Sectors will be loaded here via JavaScript -->
                    </select>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-primary-custom" id="getRecommendationsBtn">
                    <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status" style="display:none;"></span>
                    <i class="fas fa-search me-2"></i>Get Recommendations
                </button>
            </div>
        </div>
    </div>

    <div id="recommendationsResult" class="row">
        <!-- Recommendations will be displayed here -->
    </div>

    <div class="modal fade" id="recommendationDetailsModal" tabindex="-1" aria-labelledby="recommendationDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recommendationDetailsModalLabel">Investment Recommendation Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBodyContent">
                    <!-- Detailed content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const sectorSelect = document.getElementById('sectorSelect');
    const getRecommendationsBtn = document.getElementById('getRecommendationsBtn');
    const recommendationsResult = document.getElementById('recommendationsResult');
    const loadingSpinner = getRecommendationsBtn.querySelector('.loading-spinner');
    const recommendationDetailsModal = new bootstrap.Modal(document.getElementById('recommendationDetailsModal'));
    const modalBodyContent = document.getElementById('modalBodyContent');

    // Function to fetch sectors
    async function fetchSectors() {
        try {
            const response = await fetch('/api/governorates/sectors/');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const sectors = await response.json();
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector.name;
                option.textContent = sector.name;
                sectorSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching sectors:', error);
            alert('Could not load sectors. Please try again later.');
        }
    }

    // Function to fetch recommendations - No longer makes an AJAX call
    function redirectToRecommendations(sectorName) {
        if (sectorName) {
            window.location.href = `/api/analytics/investment-recommendations-page/${encodeURIComponent(sectorName)}/`;
        } else {
            alert('Please select a business sector.');
        }
    }

    function displayRecommendationDetails(rec) {
        modalBodyContent.innerHTML = `
            <h4>${rec.governorate.name} - ${rec.recommendation_details.sector_name} Sector</h4>
            <hr>
            <h5>Ranking & Overview</h5>
            <p><strong>Ranking Score:</strong> ${rec.ranking_score || 'N/A'}/100</p>
            <p><strong>Description:</strong> ${rec.recommendation_details.description || 'No description provided.'}</p>
            <hr>
            
            <h5>Actionable Next Steps</h5>
            <h6>Contact Information:</h6>
            <p>${rec.contact_info_investment_offices || 'Not available.'}</p>
            <h6>Relevant Government Agencies:</h6>
            <p>${rec.relevant_government_agencies || 'Not available.'}</p>
            <h6>Required Permits & Procedures:</h6>
            <p>${rec.required_permits_procedures || 'Not available.'}</p>
            <h6>Timeline for Setup:</h6>
            <p>${rec.timeline_for_setup || 'Not available.'}</p>
            <h6>Investment Size Recommendations:</h6>
            <p>${rec.investment_size_recommendations || 'Not available.'}</p>
            <hr>
            
            <h5>Comprehensive Data Display</h5>
            <h6>Labor Force Statistics:</h6>
            ${rec.labor_market_data ? `
                <ul>
                    <li><strong>Year:</strong> ${rec.labor_market_data.year}</li>
                    <li><strong>Unemployment Rate:</strong> ${rec.labor_market_data.unemployment_rate}%</li>
                    <li><strong>Youth Unemployment:</strong> ${rec.labor_market_data.youth_unemployment}%</li>
                    <li><strong>Female Unemployment:</strong> ${rec.labor_market_data.female_unemployment}%</li>
                    <li><strong>Labor Force Participation:</strong> ${rec.labor_market_data.labor_force_participation}%</li>
                    <li><strong>Average Wage:</strong> ${rec.labor_market_data.average_wage ? rec.labor_market_data.average_wage.toLocaleString('en-US', { style: 'currency', currency: 'TND' }) : 'N/A'}</li>
                    <li><strong>Job Creation Rate:</strong> ${rec.labor_market_data.job_creation_rate}%</li>
                </ul>
            ` : '<p>No labor market data available.</p>'}

            <h6>Infrastructure Details:</h6>
            <p>${rec.infrastructure_details || 'Not available.'}</p>
            
            <h6>Economic Incentives:</h6>
            <p>${rec.economic_incentives || 'Not available.'}</p>
            
            <h6>Geographic Advantages:</h6>
            <p>${rec.geographic_advantages || 'Not available.'}</p>

            <h6>Cost Analysis:</h6>
            ${rec.real_estate_data ? `
                <ul>
                    <li><strong>Residential Price/m²:</strong> ${rec.real_estate_data.residential_price_per_m2 ? rec.real_estate_data.residential_price_per_m2.toLocaleString('en-US', { style: 'currency', currency: 'TND' }) : 'N/A'}</li>
                    <li><strong>Commercial Price/m²:</strong> ${rec.real_estate_data.commercial_price_per_m2 ? rec.real_estate_data.commercial_price_per_m2.toLocaleString('en-US', { style: 'currency', currency: 'TND' }) : 'N/A'}</li>
                    <li><strong>Land Price/m²:</strong> ${rec.real_estate_data.land_price_per_m2 ? rec.real_estate_data.land_price_per_m2.toLocaleString('en-US', { style: 'currency', currency: 'TND' }) : 'N/A'}</li>
                </ul>
            ` : '<p>No real estate data available.</p>'}
            <p>${rec.cost_analysis_summary || 'No additional cost analysis summary.'}</p>

            <h6>Success Stories:</h6>
            <p>${rec.success_stories || 'No success stories provided.'}</p>
        `;
        recommendationDetailsModal.show();
    }

    // Event Listeners
    getRecommendationsBtn.addEventListener('click', () => {
        const selectedSector = sectorSelect.value;
        redirectToRecommendations(selectedSector);
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', fetchSectors);

</script>
{% endblock %} 